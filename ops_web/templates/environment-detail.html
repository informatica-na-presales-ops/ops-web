{% extends 'index.html' %}

{% block breadcrumb %}
    {% include 'breadcrumb-root.html' %}
    <li class="breadcrumb-item text-light"><a href="{{ url_for('environments') }}">Environments</a></li>
    <li class="breadcrumb-item active text-light">{{ g.env_name }}</li>
{% endblock %}

{% block main_content %}
    <div class="row">
        <div class="col-12">
            <h2 class="text-light">{{ g.env_name }}</h2>
        </div>
    </div>

    {% if not g.env_name == 'Orphans' %}
    <div class="row bump-top-padding">
        <div class="col-12">
            <form class="form-inline" method="post" id="form-power-control"></form>
            <button type="submit" class="btn btn-outline-success" form="form-power-control" formaction="{{ url_for('environment_start', env_name=g.env_name) }}"><span class="oi oi-media-play"></span> Start</button>
            <button type="submit" class="btn btn-outline-warning" form="form-power-control" formaction="{{ url_for('environment_stop', env_name=g.env_name) }}"><span class="oi oi-media-stop"></span> Stop</button>
            <button type="button" class="btn btn-outline-danger" data-toggle="modal" data-target="#modal-delete-env"><span class="oi oi-trash"></span> Delete</button>
        </div>
    </div>
    {% endif %}

    <div class="row bump-top-padding">
        <div class="col-12">
            <table class="table table-dark table-striped d-none d-sm-block">
                <thead>
                <tr>
                    <th>State</th>
                    <th>Name</th>
                    <th>Public IP</th>
                    <th>Cloud</th>
                    <th>Region</th>
                    <th>Type</th>
                    <th>Running Schedule</th>
                    <th>Owner</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                {% for m in g.machines %}
                    <tr>
                        <td>{{ m.state }}</td>
                        <td title="{{ m.id }}">{{ m.name }}</td>
                        <td>{{ m.public_ip or '' }}</td>
                        <td>{{ m.cloud }}</td>
                        <td>{{ m.region }}</td>
                        <td>{{ m.type }}</td>
                        <td>{{ m.running_schedule }}</td>
                        <td>{{ m.owner }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-sm btn-outline-light" data-toggle="modal" data-target="#modal-edit-{{ loop.index }}" title="Edit machine"><span class="oi oi-pencil"></span></button>
                                <button type="button" class="btn btn-sm btn-outline-light" {% if m.state != 'stopped' %}disabled title="Please stop the instance before creating an image."{% endif %} data-toggle="modal" data-target="#modal-image-{{ loop.index }}" title="Create image">
                                    <span class="oi oi-hard-drive"></span>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-light" data-toggle="modal" data-target="#modal-delete-{{ loop.index }}" title="Delete machine"><span class="oi oi-trash"></span></button>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>

            <div class="d-block d-sm-none">
            {% for m in g.machines %}
                <div class="card text-light bg-dark border-light mb-2">
                    <div class="card-body">
                        <h5 class="card-title">{{ m.name }}</h5>
                        <p class="card-text">
                            <span class="badge badge-light">State: {{ m.state }}</span>
                            <span class="badge badge-light">Public IP: {{ m.public_ip or '' }}</span>
                            <span class="badge badge-light">Cloud: {{ m.cloud }}</span>
                            <span class="badge badge-light">Region: {{ m.region }}</span>
                            <span class="badge badge-light">Type: {{ m.type }}</span>
                            <span class="badge badge-light">Running Schedule: {{ m.running_schedule }}</span>
                            <span class="badge badge-light">Owner: {{ m.owner }}</span>
                        </p>
                        <button type="button" class="btn btn-outline-light mb-2" data-toggle="modal" data-target="#modal-edit-{{ loop.index }}">
                            <span class="oi oi-pencil"></span>
                            Edit machine
                        </button>
                        <button type="button" class="btn btn-outline-light mb-2" data-toggle="modal" data-target="#modal-image-{{ loop.index }}" {{ 'disabled' if m.state != 'stopped' }}>
                            <span class="oi oi-hard-drive"></span>
                            Create image
                        </button>
                        <button type="button" class="btn btn-outline-light mb-2" data-toggle="modal" data-target="#modal-delete-{{ loop.index }}">
                            <span class="oi oi-trash"></span>
                            Delete machine
                        </button>
                    </div>
                </div>
            {% endfor %}
            </div>
        </div>
    </div>

    {% for m in g.machines %}
    <div class="modal" id="modal-edit-{{ loop.index }}">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title text-light">Edit machine</h5>
                    <button type="button" class="close text-light" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="form-edit-{{ loop.index }}" action="{{ url_for('machine_edit')}}" method="post">
                        <input type="hidden" name="environment" value="{{ g.env_name }}">
                        <input type="hidden" name="machine-id" value="{{ m.id }}">
                        <input type="hidden" name="cloud" value="{{ m.cloud }}">
                        <input type="hidden" name="region" value="{{ m.region }}">
                        <div class="form-group">
                            <label for="form-edit-{{ loop.index }}-name" class="text-light">Machine name</label>
                            <input type="text" class="form-control" id="form-edit-{{ loop.index }}-name" name="machine-name" value="{{ m.name }}">
                        </div>
                        <div class="form-group">
                            <label for="form-edit-{{ loop.index }}-schedule" class="text-light">Running schedule</label>
                            <input type="text" class="form-control" id="form-edit-{{ loop.index }}-schedule" name="running-schedule" value="{{ m.running_schedule }}">
                        </div>
                        <div class="form-group">
                            <label for="form-edit-{{ loop.index }}-owner" class="text-light">Owner</label>
                            <input type="text" class="form-control" id="form-edit-{{ loop.index }}-owner" name="owner" value="{{ m.owner }}">
                        </div>
                        <div class="form-group">
                            <label for="form-edit-{{ loop.index }}-contributors" class="text-light">Contributors</label>
                            <textarea class="form-control" id="form-edit-{{ loop.index }}-contributors" name="contributors" maxlength="255">{{ m.contributors }}</textarea>
                            <small class="form-text text-muted">Contributors can start, stop, edit, and delete a machine. Separate multiple email addresses with a space.</small>
                        </div>
                        <div class="form-group">
                            <label for="form-edit-{{ loop.index }}-application-env" class="text-light">Application environment</label>
                            <input type="text" class="form-control" id="form-edit-{{ loop.index }}-application-env" name="application-env" value="{{ m.application_env }}">
                        </div>
                        <div class="form-group">
                            <label for="form-edit-{{ loop.index }}-business-unit" class="text-light">Business unit</label>
                            <input type="text" class="form-control" id="form-edit-{{ loop.index }}-business-unit" name="business-unit" value="{{ m.business_unit }}">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-light" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-outline-success" form="form-edit-{{ loop.index }}">Save</button>
                </div>
            </div>
        </div>
    </div>

     <div class="modal" id="modal-image-{{ loop.index }}">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title text-light">Create image</h5>
                    <button type="button" class="close text-light" data-dismiss="modal" >&times;</button>
                </div>
                <div class="modal-body">
                    <form id="form-image-{{ loop.index }}" action="{{ url_for('image_create')}}" method="post">
                        <input type="hidden" name="environment" value="{{ g.env_name }}">
                        <input type="hidden" name="cloud" value="{{ m.cloud }}">
                        <input type="hidden" name="region" value="{{ m.region }}">
                        <input type="hidden" name="machine-id" value="{{ m.id }}">
                        <div class="form-group">
                            <label for="form-image-{{ loop.index }}-name" class="text-light">Image name</label>
                            <input type="text" class="form-control" id="form-image-{{ loop.index }}-name" name="image-name" value="{{ m.name }}">
                        </div>
                         <div class="form-group">
                            <label for="form-image-{{ loop.index }}-owner" class="text-light">Owner</label>
                            <input type="text" class="form-control" id="form-image-{{ loop.index }}-owner" name="owner" value="{{ m.owner }}">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-light" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-outline-success" form="form-image-{{ loop.index }}">Create</button>
                </div>
            </div>
        </div>
     </div>

    <div class="modal" id="modal-delete-{{ loop.index }}">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title text-light">Delete machine</h5>
                    <button type="button" class="close text-light" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p class="text-light lead">{{ m.name }}</p>
                    <p class="text-light">Are you sure you want to delete this machine?</p>
                    <p class="text-light"><strong class="text-danger">This action is permanent. All data will be lost.</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-light" data-dismiss="modal">Cancel</button>
                    <form class="form-inline" action="{{ url_for('machine_delete') }}" method="post">
                        <input type="hidden" name="environment" value="{{ g.env_name }}">
                        <input type="hidden" name="cloud" value="{{ m.cloud }}">
                        <input type="hidden" name="region" value="{{ m.region }}">
                        <input type="hidden" name="machine-id" value="{{ m.id }}">
                        <button type="submit" class="btn btn-outline-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <div class="modal" id="modal-delete-env">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-body">
                    <p class="text-light">Are you sure you want to delete all the machines in this environment?</p>
                    <p class="text-light"><strong class="text-danger">This action is permanent. All data will be lost.</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-light" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-outline-danger" form="form-power-control" formaction="{{ url_for('environment_delete', env_name=g.env_name) }}">Delete</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
